# QRオーダーシステムのセッション管理設計まとめ

## 課題と要件

QRオーダーシステムのセッション管理において重要な要件：

1. **複数人が同じQRコードを読み取っても破綻しないこと**
   - 団体客が同じテーブルで複数のデバイスから注文できる必要がある
   - 全員が同じ注文情報を共有できる必要がある

2. **会計後は同じURLを叩いても注文できないようにすること**
   - 会計完了後に同じQRコードで再注文できないようにする
   - テーブルリセット後に新しい客が注文できるようにする

## 設計アプローチの検討

### 初期設計案：QRコードバージョン管理

テーブル: table_status

- table_id (PK): テーブルの識別子（例：T003）
- status: テーブルの状態（空席/使用中/会計済み）
- current_order_group_id: 現在の注文グループID
- qr_code_version: QRコードのバージョン（テーブルリセット時に更新）

テーブル: sessions

- session_id (PK): セッションの識別子
- table_id (FK): 関連するテーブルID
- qr_code_version: セッション作成時のQRコードバージョン

特徴：

- QRコードにバージョン情報を埋め込む（例：`table_id=T003&v=123`）
- テーブルリセット時にQRコードバージョンを更新し、新しいQRコードを生成
- 古いバージョンのQRコードではアクセス拒否

課題：

- 紙のQRコードを使用する場合、頻繁に交換する必要がある
- 運用負担が大きい

### 改善案：静的QRコード + リダイレクト + UUID

テーブル: tables

- table_id (PK): テーブルの識別子（例：T003）
- status: テーブルの状態（空席/使用中/会計済み）
- current_group_id: 現在の注文グループID

テーブル: order_tokens

- token (PK): UUIDトークン
- table_id (FK): 関連するテーブルID
- created_at: 作成時間
- expires_at: 有効期限（オプション）

特徴：

- 静的なQRコードを使用（テーブルID + 推測困難なUID）
- QRコード読み取り → リダイレクト → 一時トークン発行のフロー
- テーブル状態に基づいたアクセス制御
- トークンは会計時に物理削除

メリット：

- 紙のQRコードを頻繁に交換する必要がない
- 運用負担が軽減される
- シンプルな実装

## 最終的な設計方針

### データ構造

テーブル: tables

- table_id (PK): テーブルの識別子（例：T003）
- status: テーブルの状態（空席/使用中/会計済み）
- current_group_id: 現在の注文グループID
- last_updated: 最終更新時間

テーブル: order_tokens

- token (PK): UUIDトークン
- table_id (FK): 関連するテーブルID
- group_id: 注文グループID
- created_at: 作成時間
- last_used: 最終使用時間
- expires_at: 有効期限（フェイルセーフ用）

テーブル: orders

- order_id (PK): 注文ID
- group_id (FK): 注文グループID
- menu_item_id: 商品ID
- quantity: 数量
- price: 価格
- status: 注文状態
- created_at: 注文時間

### フロー

1. **初回アクセス**
   - 顧客がテーブルのQRコードを読み取る
   - サーバーがテーブル状態を確認
   - テーブルが「空席」の場合、新しいUUIDトークンを生成しリダイレクト
   - テーブル状態を「使用中」に更新

2. **注文処理**
   - 注文リクエストにトークンを含める
   - サーバーがトークンを検証
   - 有効なトークンであれば注文を処理

3. **複数人のアクセス**
   - 同じテーブルの別の人がQRコードを読み取る
   - テーブルが「使用中」の場合、既存の注文グループに接続
   - 新しいトークンを発行（同一グループに紐付け）

4. **会計処理**
   - 店舗側で会計ボタンを押下
   - テーブル状態を「会計済み」に更新
   - 関連するすべてのトークンを削除

5. **テーブルリセット**
   - 店舗側でテーブルリセットボタンを押下
   - テーブル状態を「空席」に変更

### トークン管理

- トークンはUUIDを使用（衝突確率は実質的にゼロ）
- 会計時に物理削除を基本とする
- フェイルセーフとして緩やかな有効期限を設定
  - 営業時間外の自動クリーンアップ
  - 未会計のまま放置された場合の対策

### セキュリティ対策

- HTTPS通信の強制
- Secure属性付きCookieでのトークン管理
- リダイレクト時のヒストリー操作（戻るボタン対策）
- テーブル状態変更権限の制限（店舗側のみ）

## 運用上の考慮点

- 紙のQRコードを使用する場合も頻繁な交換が不要
- テーブルリセットは簡単な操作で完了
- 障害発生時のリカバリー手段としてログを保持
- 定期的なバックグラウンドジョブによるクリーンアップ

この設計により、複数人での同時利用と会計後のアクセス制御という2つの重要な要件を満たしつつ、飲食店にとって運用負担の少ないシステムを実現できます。
