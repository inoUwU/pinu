# 改良版セッション管理設計（改善版）

## 基本方針

QRオーダーシステムのセッション管理において最も重要な要件は以下の2点です：

1. **複数人が同じQRコードを読み取っても破綻しないこと**
2. **会計後は同じURLを叩いても注文できないこと**

これらの要件を満たすために、テーブル状態とセッション管理を分離した設計を採用します。

## データベース設計

### テーブル構造

```
テーブル: table_status
- table_id (PK): テーブルの識別子（例：T003）
- status: テーブルの状態（空席/使用中/会計済み）
- current_order_group_id: 現在の注文グループID
- last_updated: 最終更新時間
- available_until: 利用可能期限（店舗設定による）
- qr_code_version: QRコードのバージョン（テーブルリセット時に更新）

テーブル: sessions
- session_id (PK): セッションの識別子
- table_id (FK): 関連するテーブルID
- qr_code_version: セッション作成時のQRコードバージョン
- device_fingerprint: デバイス識別情報（オプション）
- created_at: セッション作成時間
- last_access: 最終アクセス時間
- expires_at: セッション有効期限

テーブル: order_groups
- order_group_id (PK): 注文グループID
- table_id (FK): 関連するテーブルID
- qr_code_version: 作成時のQRコードバージョン
- status: 状態（進行中/会計済み）
- created_at: 作成時間
- completed_at: 会計完了時間

テーブル: orders
- order_id (PK): 注文ID
- order_group_id (FK): 注文グループID
- menu_item_id: 注文された商品ID
- quantity: 数量
- price: 価格
- status: 注文状態（受付/調理中/提供済み）
- created_by_session_id: 注文したセッションID
- created_at: 注文時間
```

## セッション管理フロー（改善版）

```mermaid
sequenceDiagram
    participant 顧客 as 顧客（スマホ）
    participant ブラウザ as ブラウザ
    participant サーバー as サーバー
    participant DB as データベース
    participant 店舗 as 店舗管理画面

    顧客->>ブラウザ: QRコードを読み取る（URLに table_id=T003&v=123）
    ブラウザ->>サーバー: /order?table_id=T003&v=123 にアクセス
    サーバー->>DB: テーブル状態とQRコードバージョンを確認
    
    alt QRコードバージョンが一致しない
        DB-->>サーバー: バージョン不一致情報を返却
        サーバー-->>ブラウザ: 無効なQRコードページを表示
        note over ブラウザ: 以降の処理は行わない
    else テーブル状態が「空席」かつバージョン一致
        DB-->>サーバー: テーブル情報を返却
        サーバー->>DB: テーブル状態を「使用中」に更新
        サーバー->>DB: 新しい注文グループを作成
    else テーブル状態が「使用中」かつバージョン一致
        DB-->>サーバー: 既存の注文グループ情報を返却
    else テーブル状態が「会計済み」かつバージョン一致
        DB-->>サーバー: 会計済み情報を返却
        サーバー-->>ブラウザ: 会計済みページを表示（注文不可）
        note over ブラウザ: 以降の処理は行わない
    end
    
    サーバー->>サーバー: セッションIDを生成
    サーバー->>DB: セッション情報を保存（テーブルID、QRバージョンと紐付け）
    サーバー-->>ブラウザ: 注文ページを返却（セッションIDをクッキーで付与）
    
    顧客->>ブラウザ: メニューを選択し注文を確定
    ブラウザ->>サーバー: 注文情報 + セッションID を送信
    サーバー->>DB: セッションとQRバージョンを検証
    
    alt セッション有効かつテーブル状態が「使用中」かつQRバージョン一致
        サーバー->>DB: 注文情報を保存
        DB-->>サーバー: 保存成功
        サーバー-->>店舗: 注文情報を通知
        サーバー-->>ブラウザ: 注文完了ページ
    else セッション無効または期限切れ
        サーバー-->>ブラウザ: エラーページを表示
    else テーブル状態が「会計済み」またはQRバージョン不一致
        サーバー-->>ブラウザ: 会計済み/無効なQRコードページを表示
    end
    
    店舗->>サーバー: 会計ボタン押下
    サーバー->>DB: テーブル状態を「会計済み」に変更
    サーバー->>DB: 注文グループを「会計済み」に更新
    サーバー-->>ブラウザ: 会計完了ページを表示
    
    店舗->>サーバー: テーブルリセットボタン押下
    サーバー->>DB: QRコードバージョンを更新
    サーバー->>DB: テーブル状態を「空席」に変更
    サーバー->>DB: 新QRコードを生成
    サーバー-->>店舗: 新しいQRコードを表示
    
    note over 顧客,DB: 古いQRコードではバージョン不一致となり<br/>新規セッションは作成できない
```

## QRコードバージョン管理

* **問題点の解決策**: テーブルごとに「QRコードバージョン」を管理
* テーブルをリセットする際に、QRコードバージョンを更新（インクリメント）
* QRコード自体にバージョン情報を埋め込む（例：`table_id=T003&v=123`）
* セッション作成時にQRコードバージョンを記録し、常に検証

## 複数人での同時利用

* 同じテーブルIDと同じQRコードバージョンに対して複数のセッションが存在可能
* すべてのセッションは同じ注文グループに紐づく
* どのセッションからでも注文情報を閲覧・追加可能
* リアルタイム更新（WebSocketなど）を使って全セッションに注文情報を同期

## 会計後のアクセス制御

* 会計処理後はテーブル状態が「会計済み」になる
* 既存のセッションでアクセスしても注文不可の状態になる
* 新規にQRコードを読み取っても「会計済み」と表示される
* テーブルリセット時には必ずQRコードバージョンを更新し、新しいQRコードを生成
* **重要**: 古いQRコードでアクセスした場合、バージョン不一致となり注文不可

## セキュリティ対策

* セッションIDはランダムな十分な長さの文字列を使用
* セッションIDはHTTPS経由でSecure属性付きCookieとして送信
* 定期的なセッション有効期限チェックを実施
* テーブル状態とQRコードバージョンの変更はサーバー側のみで可能

## 実装上の考慮点

* セッションの有効期限は店舗ごとに設定可能
* バックグラウンドジョブでの定期的なセッションクリーンアップ
* 注文情報をリアルタイムに同期するためのWebSocketサーバー
* 障害発生時のリカバリー手段として、セッション・注文情報のログを保持
* テーブルリセット時に新しいQRコードを印刷またはディスプレイに表示する機能
