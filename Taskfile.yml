# https://taskfile.dev

version: "3"

vars:
  BACKEND_DIR: backend
  FRONTEND_DIR: frontend

tasks:
  default:
    desc: åˆ©ç”¨å¯èƒ½ãªã‚¿ã‚¹ã‚¯ã‚’è¡¨ç¤º
    cmds:
      - task --list

  setup:
    desc: åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆç’°å¢ƒå¤‰æ•°ã€ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼‰
    cmds:
      - cp .env.example .env
      - docker-compose up -d postgres
      - task: backend:deps
      - task: frontend:deps
    status:
      - test -f .env

  start:
    desc: é–‹ç™ºç’°å¢ƒã‚’èµ·å‹•ï¼ˆDB + ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ + ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼‰
    deps: [db:start]
    cmds:
      - task: backend:dev &
      - task: frontend:dev
    interactive: true

  stop:
    desc: é–‹ç™ºç’°å¢ƒã‚’åœæ­¢
    cmds:
      - docker-compose down
      - pkill -f "go run"
      - pkill -f "npm start"

  clean:
    desc: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å«ã‚ã¦å®Œå…¨ã«å‰Šé™¤
    cmds:
      - docker-compose down -v
      - docker system prune -f

  dev:
    desc: é–‹ç™ºç’°å¢ƒä¸€å¼èµ·å‹•ï¼ˆadminerå«ã‚€ï¼‰
    cmds:
      - docker-compose --profile dev up -d
      - echo "âœ¨ é–‹ç™ºç’°å¢ƒãŒèµ·å‹•ã—ã¾ã—ãŸï¼"
      - echo "ðŸ“Š Adminer: http://localhost:8080"
      - echo "âš¡ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: task backend:dev"
      - echo "ðŸš€ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: task frontend:dev"

  # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢é€£
  db:start:
    desc: PostgreSQLã‚’èµ·å‹•
    cmds:
      - docker-compose up -d postgres
      - echo "ðŸ˜ PostgreSQL started at localhost:5432"

  db:stop:
    desc: PostgreSQLã‚’åœæ­¢
    cmds:
      - docker-compose stop postgres

  db:reset:
    desc: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆå…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ï¼‰
    cmds:
      - docker-compose down postgres -v
      - docker-compose up -d postgres
      - echo "ðŸ”„ Database reset completed"

  db:logs:
    desc: PostgreSQLã®ãƒ­ã‚°ã‚’è¡¨ç¤º
    cmds:
      - docker-compose logs -f postgres

  # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–¢é€£
  backend:deps:
    desc: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - go mod tidy
      - go mod download

  backend:dev:
    desc: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - go run main.go
    env:
      GO_ENV: development

  backend:build:
    desc: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - go build -o ../bin/backend main.go

  backend:test:
    desc: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - go test ./... -v

  backend:lint:
    desc: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®Lintã‚’å®Ÿè¡Œ
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - golangci-lint run

  # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–¢é€£
  frontend:deps:
    desc: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - npm install

  frontend:dev:
    desc: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - npm start

  frontend:build:
    desc: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - npm run build

  frontend:test:
    desc: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - npm test

  frontend:lint:
    desc: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®Lintã‚’å®Ÿè¡Œ
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - npm run lint

  # ãƒ†ã‚¹ãƒˆé–¢é€£
  test:
    desc: å…¨ä½“ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
    cmds:
      - task: backend:test
      - task: frontend:test

  lint:
    desc: å…¨ä½“ã®Lintã‚’å®Ÿè¡Œ
    cmds:
      - task: backend:lint
      - task: frontend:lint

  # ãƒ“ãƒ«ãƒ‰é–¢é€£
  build:
    desc: å…¨ä½“ã‚’ãƒ“ãƒ«ãƒ‰
    cmds:
      - task: backend:build
      - task: frontend:build

  # ãƒ‡ãƒ—ãƒ­ã‚¤é–¢é€£
  deploy:prep:
    desc: ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™ï¼ˆãƒ“ãƒ«ãƒ‰ + ãƒ†ã‚¹ãƒˆï¼‰
    cmds:
      - task: lint
      - task: test
      - task: build
      - echo "ðŸš¢ Ready for deployment!"

  # ãƒ˜ãƒ«ã‚¹é–¢é€£
  health:
    desc: ã‚µãƒ¼ãƒ“ã‚¹ã®å¥åº·çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
    cmds:
      - echo "ðŸ” Checking services..."
      - docker-compose ps
      - curl -f http://localhost:8000/health || echo "âŒ Backend down"
      - curl -f http://localhost:3000 || echo "âŒ Frontend down"

  # ãƒ­ã‚°é–¢é€£
  logs:
    desc: å…¨ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ­ã‚°ã‚’è¡¨ç¤º
    cmds:
      - docker-compose logs -f

  logs:backend:
    desc: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ­ã‚°ã‚’è¡¨ç¤ºï¼ˆé–‹ç™ºæ™‚ï¼‰
    cmds:
      - echo "Backend logs (use Ctrl+C to exit)"

  # ä¾¿åˆ©ã‚³ãƒžãƒ³ãƒ‰
  fresh:
    desc: å®Œå…¨ã«æ–°ã—ã„çŠ¶æ…‹ã§ç’°å¢ƒã‚’èµ·å‹•
    cmds:
      - task: clean
      - task: setup
      - task: start

  install:task:
    desc: Taskã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆåˆå›žã®ã¿ï¼‰
    cmds:
      - |
        if ! command -v task &> /dev/null; then
          echo "Installing Task..."
          sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d
        else
          echo "âœ… Task is already installed"
        fi
